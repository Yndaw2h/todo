<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idea & Project Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .app-container {
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.3);
            padding: 32px;
            max-width: 1200px;
            margin: 0 auto;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #64ffda, #bb86fc, #cf6679);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1rem;
            font-weight: 400;
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
            display: none;
        }

        .loading-indicator.active {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(100, 255, 218, 0.3);
            border-radius: 50%;
            border-top-color: #64ffda;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .project-form {
            display: flex;
            gap: 12px;
            flex: 1;
            min-width: 300px;
        }

        .project-input, .content-input {
            flex: 1;
            padding: 16px 20px;
            border: none;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
            font-size: 1rem;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .project-input::placeholder, .content-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .project-input:focus, .content-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.12);
            border-color: #64ffda;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.2);
        }

        .content-input {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .add-btn, .back-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #64ffda, #bb86fc);
            color: #000;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .add-btn:hover, .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.3);
            background: linear-gradient(135deg, #4fd3b8, #a374e8);
        }

        .back-btn {
            background: linear-gradient(135deg, #cf6679, #bb86fc);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, #b85469, #a374e8);
        }

        .project-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #64ffda;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .project-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            animation: cardSlideIn 0.4s ease-out;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 15px 35px rgba(100, 255, 218, 0.1);
            border-color: rgba(100, 255, 218, 0.3);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .project-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #e0e0e0;
            margin-bottom: 8px;
        }

        .project-meta {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .project-content-preview {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 16px 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .edit-btn {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .delete-btn {
            background: rgba(207, 102, 121, 0.2);
            color: #cf6679;
            border: 1px solid rgba(207, 102, 121, 0.3);
        }

        .action-btn:hover {
            transform: scale(1.05);
        }

        .edit-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        .delete-btn:hover {
            background: rgba(207, 102, 121, 0.3);
        }

        .project-detail {
            display: none;
        }

        .project-detail.active {
            display: block;
        }

        .detail-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .detail-title {
            font-size: 2rem;
            font-weight: 700;
            color: #64ffda;
            margin-bottom: 12px;
        }

        .detail-meta {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.95rem;
        }

        .content-section {
            margin-bottom: 32px;
        }

        .content-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .content-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .content-item:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(100, 255, 218, 0.3);
        }

        .content-item.editing {
            background: rgba(100, 255, 218, 0.1);
            border-color: #64ffda;
        }

        .content-text {
            color: #e0e0e0;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 1.6em;
        }

        /* Link styling */
        .content-text a {
            color: #64ffda;
            text-decoration: none;
            border-bottom: 1px solid rgba(100, 255, 218, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .content-text a:hover {
            color: #4fd3b8;
            border-bottom-color: #4fd3b8;
            text-shadow: 0 0 8px rgba(100, 255, 218, 0.4);
        }

        .content-text a:visited {
            color: #bb86fc;
            border-bottom-color: rgba(187, 134, 252, 0.3);
        }

        .content-text a:visited:hover {
            color: #a374e8;
            border-bottom-color: #a374e8;
        }

        .content-text a::after {
            content: ' ‚Üó';
            font-size: 0.8em;
            opacity: 0.6;
        }

        .content-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-family: inherit;
            font-size: inherit;
            line-height: 1.6;
            resize: vertical;
            min-height: 60px;
            outline: none;
        }

        .content-actions {
            display: none;
            gap: 8px;
            margin-top: 12px;
        }

        .content-item.editing .content-actions {
            display: flex;
        }

        .save-btn, .cancel-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .save-btn {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .cancel-btn {
            background: rgba(207, 102, 121, 0.2);
            color: #cf6679;
            border: 1px solid rgba(207, 102, 121, 0.3);
        }

        .save-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        .cancel-btn:hover {
            background: rgba(207, 102, 121, 0.3);
        }

        .edit-hint {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .content-item:hover .edit-hint {
            opacity: 1;
        }

        .content-item.editing .edit-hint {
            display: none;
        }

        .content-date {
            font-size: 0.825rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 12px;
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 64px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-text {
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .empty-subtext {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .add-content-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #bb86fc;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .file-btn {
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #bb86fc, #cf6679);
            color: #000;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: inline-block;
        }

        .file-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(187, 134, 252, 0.3);
            background: linear-gradient(135deg, #a374e8, #b85469);
        }

        .file-preview {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            display: none;
        }

        .file-preview.active {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #bb86fc;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-name input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 4px 8px;
            color: #bb86fc;
            font-weight: 600;
            font-size: inherit;
            flex: 1;
        }

        .file-name input:focus {
            outline: none;
            border-color: #bb86fc;
            background: rgba(255, 255, 255, 0.15);
        }

        .file-content {
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .file-content-editable {
            width: 100%;
            min-height: 120px;
            max-height: 300px;
            resize: vertical;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: #e0e0e0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .file-content-editable:focus {
            outline: none;
            border-color: #64ffda;
            background: rgba(0, 0, 0, 0.4);
        }

        .file-edit-toggle {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-edit-toggle:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        .file-edit-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .file-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-save-btn {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .file-cancel-btn {
            background: rgba(207, 102, 121, 0.2);
            color: #cf6679;
            border: 1px solid rgba(207, 102, 121, 0.3);
        }

        .file-reset-btn {
            background: rgba(187, 134, 252, 0.2);
            color: #bb86fc;
            border: 1px solid rgba(187, 134, 252, 0.3);
        }

        .file-save-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        .file-cancel-btn:hover {
            background: rgba(207, 102, 121, 0.3);
        }

        .file-reset-btn:hover {
            background: rgba(187, 134, 252, 0.3);
        }

        .file-edit-hint {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 8px;
            font-style: italic;
        }

        .content-type-tag {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(187, 134, 252, 0.2);
            color: #bb86fc;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 8px;
            border: 1px solid rgba(187, 134, 252, 0.3);
        }

        .file-info {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 8px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 12px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .content-actions-bar {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .copy-btn, .download-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .copy-btn {
            background: rgba(187, 134, 252, 0.2);
            color: #bb86fc;
            border: 1px solid rgba(187, 134, 252, 0.3);
        }

        .download-btn {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
        }

        .copy-btn:hover {
            background: rgba(187, 134, 252, 0.3);
        }

        .download-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        /* File editor in content items */
        .file-editor-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-editor-title {
            font-weight: 600;
            color: #bb86fc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-file-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 6px;
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
            border: 1px solid rgba(100, 255, 218, 0.3);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .edit-file-btn:hover {
            background: rgba(100, 255, 218, 0.3);
        }

        /* Toast animations */
        @keyframes slideInRight {
            from {
                transform: translateX(300px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(300px);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 24px;
                margin: 16px;
            }

            .controls {
                flex-direction: column;
            }

            .project-form {
                min-width: unset;
            }

            .projects-grid {
                grid-template-columns: 1fr;
            }

            .project-stats {
                flex-direction: column;
                gap: 16px;
            }

            .stat {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .form-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <div>Initializing database...</div>
        </div>

        <!-- Main View -->
        <div id="mainView">
            <div class="app-header">
                <h1 class="app-title">Ideas & Projects</h1>
                <p class="app-subtitle">Organize your thoughts, build your dreams</p>
            </div>

            <div class="controls">
                <form class="project-form" id="projectForm">
                    <input 
                        type="text" 
                        class="project-input" 
                        id="projectInput" 
                        placeholder="Create a new project..." 
                        required
                    >
                    <button type="submit" class="add-btn">Create</button>
                </form>
            </div>

            <div class="project-stats">
                <div class="stat">
                    <span class="stat-number" id="totalProjects">0</span>
                    <span class="stat-label">Projects</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="totalIdeas">0</span>
                    <span class="stat-label">Ideas</span>
                </div>
                <div class="stat">
                    <span class="stat-number" id="recentActivity">0</span>
                    <span class="stat-label">Recent</span>
                </div>
            </div>

            <div class="projects-grid" id="projectsGrid">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">üí°</div>
                    <div class="empty-text">No projects yet</div>
                    <div class="empty-subtext">Create your first project to start capturing ideas!</div>
                </div>
            </div>
        </div>

        <!-- Project Detail View -->
        <div class="project-detail" id="projectDetail">
            <div class="detail-header">
                <button class="back-btn" id="backBtn">‚Üê Back to Projects</button>
                <h2 class="detail-title" id="detailTitle">Project Title</h2>
                <div class="detail-meta" id="detailMeta">Created on...</div>
            </div>

            <div class="add-content-form">
                <h3 class="form-title">Add New Idea</h3>
                <form id="contentForm">
                    <textarea 
                        class="content-input" 
                        id="contentInput" 
                        placeholder="Text[link]"
                    ></textarea>
                    
                    <div class="file-preview" id="filePreview">
                        <div class="file-name" id="fileName"></div>
                        <div class="content-type-tag" id="fileType"></div>
                        <div class="file-content" id="fileContent"></div>
                        <div class="file-info" id="fileInfo"></div>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="add-btn">Add Idea</button>
                        <div class="file-input-wrapper">
                            <input type="file" id="fileInput" class="file-input" accept=".txt,.md,.js,.html,.css,.json,.xml,.csv,.log,.py,.java,.cpp,.c,.h,.php,.rb,.go,.rs,.ts,.jsx,.tsx,.vue,.svelte,.sql,.sh,.bat,.yml,.yaml,.toml,.ini,.conf,.config,.jpg,.jpeg,.png,.gif,.bmp,.webp,.svg">
                            <label for="fileInput" class="file-btn">üìé Add File</label>
                        </div>
                    </div>
                </form>
            </div>

            <div class="content-section">
                <div class="content-list" id="contentList">
                    <!-- Content items will be added here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Enhanced Ideas & Projects Manager with IndexedDB
         * Features: Create projects, add content/ideas, file support, persistent storage, clickable links, file editing
         */

        class DatabaseManager {
            constructor() {
                this.dbName = 'ProjectManagerDB';
                this.dbVersion = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = () => {
                        console.error('Database error:', request.error);
                        reject(request.error);
                    };

                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Create projects store
                        if (!db.objectStoreNames.contains('projects')) {
                            const projectStore = db.createObjectStore('projects', { keyPath: 'id' });
                            projectStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }

                        // Create content store
                        if (!db.objectStoreNames.contains('content')) {
                            const contentStore = db.createObjectStore('content', { keyPath: 'id' });
                            contentStore.createIndex('projectId', 'projectId', { unique: false });
                            contentStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }

                        // Create counters store
                        if (!db.objectStoreNames.contains('counters')) {
                            const counterStore = db.createObjectStore('counters', { keyPath: 'name' });
                            // Initialize counters
                            counterStore.add({ name: 'projectId', value: 1 });
                            counterStore.add({ name: 'contentId', value: 1 });
                        }
                    };
                });
            }

            async getNextId(counterName) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['counters'], 'readwrite');
                    const store = transaction.objectStore('counters');
                    
                    const getRequest = store.get(counterName);
                    getRequest.onsuccess = () => {
                        const counter = getRequest.result || { name: counterName, value: 1 };
                        const nextId = counter.value;
                        counter.value = nextId + 1;
                        
                        const putRequest = store.put(counter);
                        putRequest.onsuccess = () => resolve(nextId);
                        putRequest.onerror = () => reject(putRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
            }

            async saveProject(project) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['projects'], 'readwrite');
                    const store = transaction.objectStore('projects');
                    
                    const request = store.put(project);
                    request.onsuccess = () => resolve(project);
                    request.onerror = () => reject(request.error);
                });
            }

            async getProject(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['projects'], 'readonly');
                    const store = transaction.objectStore('projects');
                    
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllProjects() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['projects'], 'readonly');
                    const store = transaction.objectStore('projects');
                    
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteProject(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['projects', 'content'], 'readwrite');
                    const projectStore = transaction.objectStore('projects');
                    const contentStore = transaction.objectStore('content');
                    
                    // Delete project
                    const deleteProjectRequest = projectStore.delete(id);
                    
                    // Delete all content for this project
                    const contentIndex = contentStore.index('projectId');
                    const contentRequest = contentIndex.getAllKeys(id);
                    
                    contentRequest.onsuccess = () => {
                        const contentIds = contentRequest.result;
                        contentIds.forEach(contentId => {
                            contentStore.delete(contentId);
                        });
                    };

                    transaction.oncomplete = () => resolve(true);
                    transaction.onerror = () => reject(transaction.error);
                });
            }

            async saveContent(content) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['content'], 'readwrite');
                    const store = transaction.objectStore('content');
                    
                    const request = store.put(content);
                    request.onsuccess = () => resolve(content);
                    request.onerror = () => reject(request.error);
                });
            }

            async getProjectContent(projectId) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['content'], 'readonly');
                    const store = transaction.objectStore('content');
                    const index = store.index('projectId');
                    
                    const request = index.getAll(projectId);
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteContent(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['content'], 'readwrite');
                    const store = transaction.objectStore('content');
                    
                    const request = store.delete(id);
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            async getTotalIdeasCount() {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['content'], 'readonly');
                    const store = transaction.objectStore('content');
                    
                    const request = store.count();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getRecentProjectsCount(days = 7) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['projects', 'content'], 'readonly');
                    const projectStore = transaction.objectStore('projects');
                    const contentStore = transaction.objectStore('content');
                    
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - days);
                    const weekAgoISO = weekAgo.toISOString();
                    
                    // Get all projects
                    const projectsRequest = projectStore.getAll();
                    
                    projectsRequest.onsuccess = () => {
                        const projects = projectsRequest.result;
                        const recentProjectIds = new Set();
                        
                        // Check projects created recently
                        projects.forEach(project => {
                            if (project.createdAt > weekAgoISO) {
                                recentProjectIds.add(project.id);
                            }
                        });
                        
                        // Check content created recently
                        const contentRequest = contentStore.getAll();
                        contentRequest.onsuccess = () => {
                            const contents = contentRequest.result;
                            contents.forEach(content => {
                                if (content.createdAt > weekAgoISO) {
                                    recentProjectIds.add(content.projectId);
                                }
                            });
                            resolve(recentProjectIds.size);
                        };
                        contentRequest.onerror = () => reject(contentRequest.error);
                    };
                    
                    projectsRequest.onerror = () => reject(projectsRequest.error);
                });
            }
        }

        class ProjectManager {
            constructor() {
                this.db = new DatabaseManager();
                this.projects = [];
                this.currentProject = null;
                this.currentFileContent = null;
                this.originalFileContent = null; // Store original file content for reset
                this.fileEditMode = false;
                this.editingFileInContent = new Map(); // Track file editing states for content items

                // Get DOM elements
                this.loadingIndicator = document.getElementById('loadingIndicator');
                this.projectForm = document.getElementById('projectForm');
                this.projectInput = document.getElementById('projectInput');
                this.projectsGrid = document.getElementById('projectsGrid');
                this.emptyState = document.getElementById('emptyState');
                
                this.mainView = document.getElementById('mainView');
                this.projectDetail = document.getElementById('projectDetail');
                this.backBtn = document.getElementById('backBtn');
                this.detailTitle = document.getElementById('detailTitle');
                this.detailMeta = document.getElementById('detailMeta');
                
                this.contentForm = document.getElementById('contentForm');
                this.contentInput = document.getElementById('contentInput');
                this.contentList = document.getElementById('contentList');

                // File handling elements
                this.fileInput = document.getElementById('fileInput');
                this.filePreview = document.getElementById('filePreview');
                this.fileName = document.getElementById('fileName');
                this.fileType = document.getElementById('fileType');
                this.fileContent = document.getElementById('fileContent');
                this.fileInfo = document.getElementById('fileInfo');

                // Statistics elements
                this.totalProjectsEl = document.getElementById('totalProjects');
                this.totalIdeasEl = document.getElementById('totalIdeas');
                this.recentActivityEl = document.getElementById('recentActivity');

                this.init();
            }

            async init() {
                try {
                    this.showLoading(true);
                    await this.db.init();
                    await this.loadProjects();
                    this.bindEvents();
                    await this.updateDisplay();
                    this.showLoading(false);
                } catch (error) {
                    console.error('Failed to initialize app:', error);
                    this.showToast('Failed to initialize database. Some features may not work.');
                    this.showLoading(false);
                }
            }

            showLoading(show) {
                this.loadingIndicator.classList.toggle('active', show);
                this.mainView.style.display = show ? 'none' : 'block';
            }

            bindEvents() {
                // Project creation
                this.projectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await this.createProject();
                });

                // Content addition
                this.contentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await this.addContent();
                });

                // Ctrl+Enter shortcut for adding content
                this.contentInput.addEventListener('keydown', async (e) => {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        await this.addContent();
                    }
                });

                // File input
                this.fileInput.addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });

                // Back button
                this.backBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.showMainView();
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.projectDetail.classList.contains('active')) {
                        e.preventDefault();
                        this.showMainView();
                    }
                    
                    if (e.ctrlKey && e.key === '/' && !this.projectDetail.classList.contains('active')) {
                        e.preventDefault();
                        this.projectInput.focus();
                    }
                });
            }

            // Enhanced text processing to convert URLs and Discord-style links to clickable links
            convertLinksToHtml(text) {
                if (!text) return '';
                
                let processedText = text;
                
                // First, handle Discord-style links: text[link] or [text](link)
                // Support both Discord format text[link] and Markdown format [text](link)
                const discordLinkRegex = /([^[\s]+)\[((?:https?:\/\/|ftp:\/\/|www\.)[^\]]+)\]/gi;
                const markdownLinkRegex = /\[([^\]]+)\]\(((?:https?:\/\/|ftp:\/\/|www\.)[^)]+)\)/gi;
                
                // Handle Discord-style: text[link]
                processedText = processedText.replace(discordLinkRegex, (match, text, url) => {
                    let href = url;
                    if (url.startsWith('www.')) {
                        href = 'https://' + url;
                    }
                    
                    const displayText = this.escapeHtml(text);
                    return `<a href="${this.escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${displayText}</a>`;
                });
                
                // Handle Markdown-style: [text](link)
                processedText = processedText.replace(markdownLinkRegex, (match, text, url) => {
                    let href = url;
                    if (url.startsWith('www.')) {
                        href = 'https://' + url;
                    }
                    
                    const displayText = this.escapeHtml(text);
                    return `<a href="${this.escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${displayText}</a>`;
                });
                
                // Then handle regular URLs (but avoid double-processing already converted links)
                const urlRegex = /(?<!href=["'])(?<!>)((?:https?:\/\/|ftp:\/\/|www\.)[^\s<>"{}|\\^`[\]()]+)(?![^<]*<\/a>)/gi;
                
                processedText = processedText.replace(urlRegex, (url) => {
                    // Skip if this URL is already part of a link
                    if (processedText.indexOf(`href="${url}"`) !== -1 || processedText.indexOf(`href="https://${url}"`) !== -1) {
                        return url;
                    }
                    
                    // Add protocol if missing
                    let href = url;
                    if (url.startsWith('www.')) {
                        href = 'https://' + url;
                    }
                    
                    // Escape any HTML in the URL text
                    const displayUrl = this.escapeHtml(url);
                    
                    return `<a href="${this.escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${displayUrl}</a>`;
                });
                
                return processedText;
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) {
                    this.clearFilePreview();
                    return;
                }

                // Check if it's an image
                const isImage = file.type.startsWith('image/');
                
                if (isImage) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentFileContent = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            content: e.target.result,
                            extension: file.name.split('.').pop()?.toLowerCase() || 'img',
                            isImage: true
                        };
                        this.originalFileContent = { ...this.currentFileContent };
                        this.fileEditMode = false;
                        this.showFilePreview();
                    };
                    reader.readAsDataURL(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.currentFileContent = {
                            name: file.name,
                            type: file.type || 'text/plain',
                            size: file.size,
                            content: e.target.result,
                            extension: file.name.split('.').pop()?.toLowerCase() || 'txt',
                            isImage: false
                        };
                        this.originalFileContent = { ...this.currentFileContent };
                        this.fileEditMode = false;
                        this.showFilePreview();
                    };
                    reader.onerror = () => {
                        alert('Error reading file. Please try again.');
                        this.clearFilePreview();
                    };
                    reader.readAsText(file);
                }
            }

            showFilePreview() {
                if (!this.currentFileContent) return;

                const { name, content, size, extension, isImage } = this.currentFileContent;
                
                this.fileType.textContent = extension.toUpperCase();
                
                if (isImage) {
                    this.fileName.innerHTML = `
                        <input type="text" value="${this.escapeHtml(name)}" onchange="projectManager.updateFileName(this.value)">
                    `;
                    this.fileContent.innerHTML = `
                        <img src="${content}" alt="${this.escapeHtml(name)}" class="image-preview">
                    `;
                    this.fileInfo.innerHTML = `
                        ${this.formatFileSize(size)} ‚Ä¢ Image
                        <div class="file-edit-hint">You can rename this image file above</div>
                    `;
                } else {
                    this.fileName.innerHTML = `
                        <input type="text" value="${this.escapeHtml(name)}" onchange="projectManager.updateFileName(this.value)">
                    `;
                    this.renderFileContent();
                    this.updateFileInfo();
                }
                
                this.filePreview.classList.add('active');
                this.filePreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            renderFileContent() {
                if (!this.currentFileContent || this.currentFileContent.isImage) return;

                const { content } = this.currentFileContent;
                
                if (this.fileEditMode) {
                    this.fileContent.innerHTML = `
                        <div style="position: relative;">
                            <textarea class="file-content-editable" id="fileContentEditor" placeholder="Edit your file content...">${this.escapeHtml(content)}</textarea>
                            <div class="file-edit-actions">
                                <button class="file-action-btn file-save-btn" onclick="projectManager.saveFileEdit()">üíæ Save Changes</button>
                                <button class="file-action-btn file-reset-btn" onclick="projectManager.resetFileContent()">‚Ü∫ Reset</button>
                                <button class="file-action-btn file-cancel-btn" onclick="projectManager.cancelFileEdit()">‚úï Cancel</button>
                            </div>
                        </div>
                    `;
                    
                    // Auto-resize textarea
                    const textarea = document.getElementById('fileContentEditor');
                    if (textarea) {
                        textarea.style.height = 'auto';
                        textarea.style.height = Math.min(textarea.scrollHeight, 400) + 'px';
                        textarea.focus();
                        
                        textarea.addEventListener('input', () => {
                            textarea.style.height = 'auto';
                            textarea.style.height = Math.min(textarea.scrollHeight, 400) + 'px';
                        });
                    }
                } else {
                    const previewContent = content.length > 2000 ? content.substring(0, 2000) + '...' : content;
                    this.fileContent.innerHTML = `
                        <div style="position: relative;">
                            <pre style="margin: 0; white-space: pre-wrap; word-break: break-word;">${this.escapeHtml(previewContent)}</pre>
                            <button class="file-edit-toggle" onclick="projectManager.toggleFileEdit()">‚úèÔ∏è Edit Content</button>
                        </div>
                    `;
                }
            }

            updateFileInfo() {
                if (!this.currentFileContent || this.currentFileContent.isImage) return;

                const { content, size } = this.currentFileContent;
                const lines = content.split('\n').length;
                const chars = content.length;
                
                this.fileInfo.innerHTML = `
                    ${this.formatFileSize(size)} ‚Ä¢ ${lines} lines ‚Ä¢ ${chars} characters
                    <div class="file-edit-hint">Click "Edit Content" to modify the file content before adding</div>
                `;
            }

            toggleFileEdit() {
                if (!this.currentFileContent || this.currentFileContent.isImage) return;
                
                this.fileEditMode = !this.fileEditMode;
                this.renderFileContent();
                this.updateFileInfo();
            }

            saveFileEdit() {
                const editor = document.getElementById('fileContentEditor');
                if (!editor || !this.currentFileContent) return;

                const newContent = editor.value;
                
                // Update current file content
                this.currentFileContent.content = newContent;
                this.currentFileContent.size = new Blob([newContent]).size;
                
                // Exit edit mode
                this.fileEditMode = false;
                this.renderFileContent();
                this.updateFileInfo();
                
                this.showToast('File content updated!');
            }

            resetFileContent() {
                if (!this.originalFileContent) return;
                
                // Reset to original content
                this.currentFileContent.content = this.originalFileContent.content;
                this.currentFileContent.size = this.originalFileContent.size;
                
                // Refresh the edit view
                this.renderFileContent();
                this.updateFileInfo();
                
                this.showToast('File content reset to original!');
            }

            cancelFileEdit() {
                this.fileEditMode = false;
                this.renderFileContent();
                this.updateFileInfo();
            }

            updateFileName(newName) {
                if (!this.currentFileContent || !newName.trim()) return;
                
                const trimmedName = newName.trim();
                this.currentFileContent.name = trimmedName;
                
                // Update extension if it changed
                const newExtension = trimmedName.split('.').pop()?.toLowerCase();
                if (newExtension && newExtension !== trimmedName) {
                    this.currentFileContent.extension = newExtension;
                    this.fileType.textContent = newExtension.toUpperCase();
                }
            }

            clearFilePreview() {
                this.currentFileContent = null;
                this.originalFileContent = null;
                this.fileEditMode = false;
                this.filePreview.classList.remove('active');
                this.fileInput.value = '';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async createProject() {
                const projectName = this.projectInput.value.trim();
                if (!projectName) return;

                try {
                    const projectId = await this.db.getNextId('projectId');
                    const newProject = {
                        id: projectId,
                        name: projectName,
                        createdAt: new Date().toISOString()
                    };

                    await this.db.saveProject(newProject);
                    this.projects.push(newProject);
                    await this.updateDisplay();
                    
                    this.projectInput.value = '';
                    setTimeout(() => {
                        this.projectInput.focus();
                    }, 50);
                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showToast('Failed to create project. Please try again.');
                }
            }

            async addContent() {
                if (!this.currentProject) return;

                const contentText = this.contentInput.value.trim();
                if (!contentText && !this.currentFileContent) return;

                try {
                    const contentId = await this.db.getNextId('contentId');
                    const newContent = {
                        id: contentId,
                        projectId: this.currentProject.id,
                        text: contentText,
                        createdAt: new Date().toISOString(),
                        file: this.currentFileContent ? {
                            name: this.currentFileContent.name,
                            type: this.currentFileContent.type,
                            size: this.currentFileContent.size,
                            content: this.currentFileContent.content,
                            extension: this.currentFileContent.extension,
                            isImage: this.currentFileContent.isImage || false
                        } : null
                    };

                    await this.db.saveContent(newContent);
                    await this.updateProjectDetail();
                    await this.updateStatistics();
                    
                    // Clear form
                    this.contentInput.value = '';
                    this.clearFilePreview();
                    
                    // Focus back to content input
                    setTimeout(() => {
                        this.contentInput.focus();
                    }, 50);
                } catch (error) {
                    console.error('Error adding content:', error);
                    this.showToast('Failed to add idea. Please try again.');
                }
            }

            async openProject(projectId) {
                try {
                    const project = await this.db.getProject(projectId);
                    if (!project) return;

                    this.currentProject = project;
                    this.showProjectDetail();
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showToast('Failed to open project.');
                }
            }

            async editProject(projectId) {
                try {
                    const project = await this.db.getProject(projectId);
                    if (!project) return;

                    const newName = prompt('Edit project name:', project.name);
                    if (newName && newName.trim()) {
                        project.name = newName.trim();
                        await this.db.saveProject(project);
                        
                        // Update local projects array
                        const localProject = this.projects.find(p => p.id === projectId);
                        if (localProject) {
                            localProject.name = project.name;
                        }
                        
                        await this.updateDisplay();
                        
                        // Update detail view if this project is currently open
                        if (this.currentProject && this.currentProject.id === projectId) {
                            this.currentProject.name = project.name;
                            this.detailTitle.textContent = project.name;
                        }
                    }
                } catch (error) {
                    console.error('Error editing project:', error);
                    this.showToast('Failed to edit project.');
                }
            }

            async editContent(contentId) {
                if (!this.currentProject) return;

                const contentElement = document.querySelector(`[data-content-id="${contentId}"]`);
                if (!contentElement) return;

                try {
                    // Get current content from database
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content) return;

                    contentElement.classList.add('editing');
                    
                    const textElement = contentElement.querySelector('.content-text');
                    const currentText = content.text || '';
                    
                    textElement.innerHTML = `
                        <textarea class="content-textarea" data-original="${this.escapeHtml(currentText)}">${this.escapeHtml(currentText)}</textarea>
                    `;

                    const textarea = textElement.querySelector('.content-textarea');
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);

                    const actionsElement = contentElement.querySelector('.content-actions');
                    actionsElement.style.display = 'flex';

                    textarea.addEventListener('input', () => {
                        textarea.style.height = 'auto';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    });

                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';

                    // If there's a file, show file editor
                    if (content.file && !content.file.isImage) {
                        const fileEditor = contentElement.querySelector('.file-editor-section');
                        if (fileEditor) {
                            this.showFileEditor(contentId, content.file);
                        }
                    }
                } catch (error) {
                    console.error('Error editing content:', error);
                    this.showToast('Failed to edit content.');
                }
            }

            showFileEditor(contentId, fileData) {
                const contentElement = document.querySelector(`[data-content-id="${contentId}"]`);
                const fileEditor = contentElement.querySelector('.file-editor-section');
                if (!fileEditor || !fileData || fileData.isImage) return;

                const fileContentDiv = fileEditor.querySelector('.file-content');
                const editButton = fileEditor.querySelector('.edit-file-btn');
                
                if (this.editingFileInContent.get(contentId)) {
                    // Show editor
                    fileContentDiv.innerHTML = `
                        <textarea class="file-content-editable" id="fileEditor_${contentId}" style="width: 100%; min-height: 200px;">${this.escapeHtml(fileData.content)}</textarea>
                        <div class="file-edit-actions">
                            <button class="file-action-btn file-save-btn" onclick="projectManager.saveContentFileEdit(${contentId})">üíæ Save File</button>
                            <button class="file-action-btn file-cancel-btn" onclick="projectManager.cancelContentFileEdit(${contentId})">‚úï Cancel</button>
                        </div>
                    `;
                    editButton.textContent = 'Cancel Edit';
                    editButton.style.background = 'rgba(207, 102, 121, 0.2)';
                    editButton.style.color = '#cf6679';
                    editButton.style.borderColor = 'rgba(207, 102, 121, 0.3)';
                    
                    // Auto-resize textarea
                    const textarea = document.getElementById(`fileEditor_${contentId}`);
                    if (textarea) {
                        textarea.style.height = 'auto';
                        textarea.style.height = Math.min(textarea.scrollHeight, 400) + 'px';
                        
                        textarea.addEventListener('input', () => {
                            textarea.style.height = 'auto';
                            textarea.style.height = Math.min(textarea.scrollHeight, 400) + 'px';
                        });
                    }
                } else {
                    // Show preview
                    const previewContent = fileData.content.length > 1000 ? fileData.content.substring(0, 1000) + '...' : fileData.content;
                    fileContentDiv.innerHTML = `<pre style="margin: 0; white-space: pre-wrap; word-break: break-word;">${this.escapeHtml(previewContent)}</pre>`;
                    editButton.textContent = '‚úèÔ∏è Edit File';
                    editButton.style.background = 'rgba(100, 255, 218, 0.2)';
                    editButton.style.color = '#64ffda';
                    editButton.style.borderColor = 'rgba(100, 255, 218, 0.3)';
                }
            }

            toggleContentFileEdit(contentId) {
                const isEditing = this.editingFileInContent.get(contentId);
                this.editingFileInContent.set(contentId, !isEditing);
                
                // Get content data to pass to showFileEditor
                this.db.getProjectContent(this.currentProject.id).then(projectContent => {
                    const content = projectContent.find(c => c.id === contentId);
                    if (content && content.file) {
                        this.showFileEditor(contentId, content.file);
                    }
                });
            }

            async saveContentFileEdit(contentId) {
                try {
                    const textarea = document.getElementById(`fileEditor_${contentId}`);
                    if (!textarea) return;

                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content || !content.file) return;

                    const newFileContent = textarea.value;
                    
                    // Update file content
                    content.file.content = newFileContent;
                    content.file.size = new Blob([newFileContent]).size;
                    content.updatedAt = new Date().toISOString();

                    await this.db.saveContent(content);
                    
                    // Exit edit mode
                    this.editingFileInContent.set(contentId, false);
                    
                    // Refresh the content display
                    await this.updateProjectDetail();
                    
                    this.showToast('File content saved!');
                } catch (error) {
                    console.error('Error saving file content:', error);
                    this.showToast('Failed to save file content.');
                }
            }

            async cancelContentFileEdit(contentId) {
                this.editingFileInContent.set(contentId, false);
                
                // Get content data and refresh file editor
                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (content && content.file) {
                        this.showFileEditor(contentId, content.file);
                    }
                } catch (error) {
                    console.error('Error canceling file edit:', error);
                }
            }

            async saveContentEdit(contentId) {
                if (!this.currentProject) return;

                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content) return;

                    const contentElement = document.querySelector(`[data-content-id="${contentId}"]`);
                    const textarea = contentElement.querySelector('.content-textarea');
                    const newText = textarea.value.trim();

                    if (!newText && !content.file) {
                        alert('Content cannot be empty unless it has a file attachment!');
                        return;
                    }

                    // Update the content
                    content.text = newText;
                    content.updatedAt = new Date().toISOString();

                    await this.db.saveContent(content);
                    
                    // Clear any file editing states
                    this.editingFileInContent.delete(contentId);
                    
                    await this.updateProjectDetail();
                } catch (error) {
                    console.error('Error saving content:', error);
                    this.showToast('Failed to save content.');
                }
            }

            async copyText(contentId) {
                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content || !content.text) return;

                    await navigator.clipboard.writeText(content.text);
                    this.showToast('Text copied to clipboard!');
                } catch (error) {
                    // Fallback for older browsers
                    try {
                        const projectContent = await this.db.getProjectContent(this.currentProject.id);
                        const content = projectContent.find(c => c.id === contentId);
                        if (!content || !content.text) return;

                        const textArea = document.createElement('textarea');
                        textArea.value = content.text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showToast('Text copied to clipboard!');
                    } catch (fallbackError) {
                        console.error('Error copying text:', fallbackError);
                        this.showToast('Failed to copy text.');
                    }
                }
            }

            async copyFileContent(contentId) {
                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content || !content.file || content.file.isImage) return;

                    await navigator.clipboard.writeText(content.file.content);
                    this.showToast('File content copied to clipboard!');
                } catch (error) {
                    // Fallback for older browsers
                    try {
                        const projectContent = await this.db.getProjectContent(this.currentProject.id);
                        const content = projectContent.find(c => c.id === contentId);
                        if (!content || !content.file || content.file.isImage) return;

                        const textArea = document.createElement('textarea');
                        textArea.value = content.file.content;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showToast('File content copied to clipboard!');
                    } catch (fallbackError) {
                        console.error('Error copying file content:', fallbackError);
                        this.showToast('Failed to copy file content.');
                    }
                }
            }

            async downloadFile(contentId) {
                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    const content = projectContent.find(c => c.id === contentId);
                    if (!content || !content.file) return;

                    const { name, content: fileContent, type, isImage } = content.file;
                    
                    const blob = isImage 
                        ? this.dataURLtoBlob(fileContent)
                        : new Blob([fileContent], { type: type || 'text/plain' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast(`${name} downloaded!`);
                } catch (error) {
                    console.error('Error downloading file:', error);
                    this.showToast('Failed to download file.');
                }
            }

            dataURLtoBlob(dataURL) {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new Blob([u8arr], { type: mime });
            }

            showToast(message) {
                // Create and show a simple toast notification
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(100, 255, 218, 0.9);
                    color: #000;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    z-index: 10000;
                    animation: slideInRight 0.3s ease-out;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 2000);
            }

            async cancelContentEdit(contentId) {
                // Clear any file editing states
                this.editingFileInContent.delete(contentId);
                // Simply re-render the project detail to reset everything
                await this.updateProjectDetail();
            }

            async deleteContent(contentId) {
                if (!this.currentProject) return;

                try {
                    await this.db.deleteContent(contentId);
                    // Clear any file editing states
                    this.editingFileInContent.delete(contentId);
                    await this.updateProjectDetail();
                    await this.updateStatistics();
                } catch (error) {
                    console.error('Error deleting content:', error);
                    this.showToast('Failed to delete content.');
                }
            }

            async deleteProject(projectId) {
                try {
                    if (this.currentProject && this.currentProject.id === projectId) {
                        this.showMainView();
                    }

                    await this.db.deleteProject(projectId);
                    
                    // Remove from local projects array
                    const projectIndex = this.projects.findIndex(p => p.id === projectId);
                    if (projectIndex > -1) {
                        this.projects.splice(projectIndex, 1);
                    }
                    
                    await this.updateDisplay();
                    
                    setTimeout(() => {
                        this.projectInput.focus();
                    }, 50);
                } catch (error) {
                    console.error('Error deleting project:', error);
                    this.showToast('Failed to delete project.');
                }
            }

            showMainView() {
                this.mainView.style.display = 'block';
                this.projectDetail.classList.remove('active');
                this.currentProject = null;
                this.clearFilePreview();
                // Clear file editing states
                this.editingFileInContent.clear();
            }

            showProjectDetail() {
                this.mainView.style.display = 'none';
                this.projectDetail.classList.add('active');
                this.updateProjectDetail();
            }

            async updateProjectDetail() {
                if (!this.currentProject) return;

                try {
                    const projectContent = await this.db.getProjectContent(this.currentProject.id);
                    
                    this.detailTitle.textContent = this.currentProject.name;
                    this.detailMeta.textContent = `Created on ${this.formatDate(this.currentProject.createdAt)} ‚Ä¢ ${projectContent.length} ideas`;

                    await this.renderContent(projectContent);
                } catch (error) {
                    console.error('Error updating project detail:', error);
                    this.showToast('Failed to load project details.');
                }
            }

            async renderContent(projectContent = null) {
                this.contentList.innerHTML = '';

                try {
                    if (!projectContent) {
                        projectContent = await this.db.getProjectContent(this.currentProject.id);
                    }

                    if (projectContent.length === 0) {
                        this.contentList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">üìù</div>
                                <div class="empty-text">No ideas yet</div>
                                <div class="empty-subtext">Add your first idea to this project!</div>
                            </div>
                        `;
                        return;
                    }

                    const sortedContent = [...projectContent].sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    );

                    sortedContent.forEach(content => {
                        const contentElement = this.createContentElement(content);
                        this.contentList.appendChild(contentElement);
                    });
                } catch (error) {
                    console.error('Error rendering content:', error);
                    this.showToast('Failed to load content.');
                }
            }

            createContentElement(content) {
                const contentItem = document.createElement('div');
                contentItem.className = 'content-item';
                contentItem.setAttribute('data-content-id', content.id);
                
                const displayDate = content.updatedAt 
                    ? `Updated ${this.formatDate(content.updatedAt)}`
                    : this.formatDate(content.createdAt);

                let fileSection = '';
                if (content.file) {
                    const fileActionsBar = `
                        <div class="content-actions-bar">
                            ${content.text ? `<button class="copy-btn" onclick="projectManager.copyText(${content.id})">üìÑ Copy Text</button>` : ''}
                            ${content.file.isImage ? 
                                `<button class="download-btn" onclick="projectManager.downloadFile(${content.id})">üíæ Download Image</button>` :
                                `<button class="copy-btn" onclick="projectManager.copyFileContent(${content.id})">üìÑ Copy File</button>
                                 <button class="download-btn" onclick="projectManager.downloadFile(${content.id})">üíæ Download File</button>`
                            }
                        </div>
                    `;

                    if (content.file.isImage) {
                        fileSection = `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div class="content-type-tag">${content.file.extension.toUpperCase()} Image</div>
                                <div style="font-weight: 600; color: #bb86fc; margin-bottom: 8px;">${this.escapeHtml(content.file.name)}</div>
                                <img src="${content.file.content}" alt="${this.escapeHtml(content.file.name)}" class="image-preview">
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.4); margin-top: 8px;">${this.formatFileSize(content.file.size)} ‚Ä¢ Image</div>
                                ${fileActionsBar}
                            </div>
                        `;
                    } else {
                        const previewContent = content.file.content.length > 1000 ? content.file.content.substring(0, 1000) + '...' : content.file.content;
                        fileSection = `
                            <div class="file-editor-section" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <div class="file-editor-header">
                                    <div class="file-editor-title">
                                        <div class="content-type-tag">${content.file.extension.toUpperCase()} File</div>
                                        <span style="font-weight: 600; color: #bb86fc;">${this.escapeHtml(content.file.name)}</span>
                                    </div>
                                    <button class="edit-file-btn" onclick="projectManager.toggleContentFileEdit(${content.id})">‚úèÔ∏è Edit File</button>
                                </div>
                                <div class="file-content" style="background: rgba(0, 0, 0, 0.2); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05); font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap;">
                                    <pre style="margin: 0; white-space: pre-wrap; word-break: break-word;">${this.escapeHtml(previewContent)}</pre>
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255, 255, 255, 0.4); margin-top: 8px;">${this.formatFileSize(content.file.size)} ‚Ä¢ ${content.file.content.split('\n').length} lines</div>
                                ${fileActionsBar}
                            </div>
                        `;
                    }
                }

                // Text content actions bar - always show if there's text content
                let textActionsBar = '';
                if (content.text) {
                    textActionsBar = `
                        <div class="content-actions-bar">
                            <button class="copy-btn" onclick="projectManager.copyText(${content.id})">üìÑ Copy Text</button>
                        </div>
                    `;
                }

                // Process text content for clickable links
                const processedText = content.text ? this.convertLinksToHtml(content.text) : (content.file ? 'File only content' : 'No text content');

                contentItem.innerHTML = `
                    <div class="edit-hint">Click to edit</div>
                    <div class="content-text">${processedText}</div>
                    ${textActionsBar}
                    ${fileSection}
                    <div class="content-actions">
                        <button class="save-btn">Save</button>
                        <button class="cancel-btn">Cancel</button>
                        <button class="delete-btn action-btn" style="margin-left: auto;">Delete</button>
                    </div>
                    <div class="content-date">${displayDate}</div>
                `;

                // Add click listener for editing (but not on links)
                contentItem.addEventListener('click', async (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || contentItem.classList.contains('editing')) {
                        return;
                    }
                    await this.editContent(content.id);
                });

                // Add event listeners to buttons
                const saveBtn = contentItem.querySelector('.save-btn');
                const cancelBtn = contentItem.querySelector('.cancel-btn');
                const deleteBtn = contentItem.querySelector('.delete-btn');

                saveBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.saveContentEdit(content.id);
                });

                cancelBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.cancelContentEdit(content.id);
                });

                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.deleteContent(content.id);
                });

                // Add keyboard shortcuts
                contentItem.addEventListener('keydown', async (e) => {
                    if (contentItem.classList.contains('editing')) {
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            await this.cancelContentEdit(content.id);
                        } else if (e.key === 'Enter' && e.ctrlKey) {
                            e.preventDefault();
                            await this.saveContentEdit(content.id);
                        }
                    }
                });

                return contentItem;
            }

            async updateDisplay() {
                await this.renderProjects();
                await this.updateStatistics();
                this.toggleEmptyState();
            }

            async renderProjects() {
                const existingProjects = this.projectsGrid.querySelectorAll('.project-card');
                existingProjects.forEach(project => project.remove());

                const sortedProjects = [...this.projects].sort((a, b) => 
                    new Date(b.createdAt) - new Date(a.createdAt)
                );

                for (const project of sortedProjects) {
                    const projectElement = await this.createProjectElement(project);
                    this.projectsGrid.appendChild(projectElement);
                }
            }

            async createProjectElement(project) {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                projectCard.setAttribute('data-project-id', project.id);

                try {
                    const projectContent = await this.db.getProjectContent(project.id);
                    
                    const previewText = projectContent.length > 0 
                        ? (projectContent[projectContent.length - 1].text || 
                           (projectContent[projectContent.length - 1].file ? 
                            (projectContent[projectContent.length - 1].file.isImage ? 'Image attachment' : 'File attachment') : 
                            'Empty content'))
                        : 'No ideas added yet...';

                    projectCard.innerHTML = `
                        <div class="project-header">
                            <div>
                                <div class="project-title">${this.escapeHtml(project.name)}</div>
                                <div class="project-meta">
                                    <span>${this.formatDate(project.createdAt)}</span>
                                    <span>${projectContent.length} ideas</span>
                                </div>
                            </div>
                        </div>
                        <div class="project-content-preview">${this.escapeHtml(previewText)}</div>
                        <div class="project-actions">
                            <button class="action-btn edit-btn">Edit</button>
                            <button class="action-btn delete-btn">Delete</button>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error creating project element:', error);
                    projectCard.innerHTML = `
                        <div class="project-header">
                            <div>
                                <div class="project-title">${this.escapeHtml(project.name)}</div>
                                <div class="project-meta">
                                    <span>${this.formatDate(project.createdAt)}</span>
                                    <span>Error loading ideas</span>
                                </div>
                            </div>
                        </div>
                        <div class="project-content-preview">Failed to load project content</div>
                        <div class="project-actions">
                            <button class="action-btn edit-btn">Edit</button>
                            <button class="action-btn delete-btn">Delete</button>
                        </div>
                    `;
                }

                projectCard.addEventListener('click', async () => {
                    await this.openProject(project.id);
                });

                // Add event listeners to action buttons
                const editBtn = projectCard.querySelector('.edit-btn');
                const deleteBtn = projectCard.querySelector('.delete-btn');

                editBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.editProject(project.id);
                });

                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await this.deleteProject(project.id);
                });

                return projectCard;
            }

            async updateStatistics() {
                try {
                    const totalProjects = this.projects.length;
                    const totalIdeas = await this.db.getTotalIdeasCount();
                    const recentActivity = await this.db.getRecentProjectsCount();

                    this.totalProjectsEl.textContent = totalProjects;
                    this.totalIdeasEl.textContent = totalIdeas;
                    this.recentActivityEl.textContent = recentActivity;
                } catch (error) {
                    console.error('Error updating statistics:', error);
                    // Set fallback values
                    this.totalProjectsEl.textContent = this.projects.length;
                    this.totalIdeasEl.textContent = '?';
                    this.recentActivityEl.textContent = '?';
                }
            }

            toggleEmptyState() {
                this.emptyState.style.display = this.projects.length === 0 ? 'block' : 'none';
            }

            async loadProjects() {
                try {
                    this.projects = await this.db.getAllProjects();
                } catch (error) {
                    console.error('Error loading projects:', error);
                    this.projects = [];
                    this.showToast('Failed to load projects.');
                }
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the app
        let projectManager;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                projectManager = new ProjectManager();
            });
        } else {
            projectManager = new ProjectManager();
        }
    </script>
</body>
</html>
